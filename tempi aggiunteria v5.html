<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tempi Aggiunteria</title>
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --success-color: #28a745;
            --primary-color: #007bff;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --background-light: #f8f9fa;           
        }

        body {
            min-height: 100vh;
            background-color: var(--background-light);
        }

        .page-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .main-title {
            text-align: center;
            color: #2c3e50;
            font-size: 2.5rem;
            margin: 2rem 0;
            font-weight: 500;
        }

        .menu-button {
            display: block;
            width: 100%;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: none;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: 500;
            text-align: center;
            color: white;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            text-decoration: none;
        }

        .menu-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            color: white;
            text-decoration: none;
        }

        .menu-button i {
            margin-right: 10px;
        }

        .btn-prototype { background-color: var(--success-color); }
        .btn-manual { background-color: var(--primary-color); }
        .btn-import { background-color: var(--warning-color); color: #000 !important; }
        .btn-load { background-color: var(--info-color); }

        .form-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .image-container {
            position: relative;
            width: 400px;
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
            background: #f8f9fa;
            margin: 0 auto;
        }

        .image-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .delete-image {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255,0,0,0.8);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            cursor: pointer;
            z-index: 2;
        }

        .time-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .time-info h5 {
            color: var(--primary-color);
            margin-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }

        .time-info p {
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .phase-header {
            padding: 12px 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .phase-header h6 {
            margin: 0;
            font-size: 1.1em;
            font-weight: 500;
        }
        
        .table-responsive {
        
            overflow-y: auto;
        }

        .summary-table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .hidden {
            display: none !important;
        }

        /* Aggiungi questi stili nella sezione <style> esistente */
                

        @media (max-width: 992px) {
            .phase-card {
                flex: 0 0 100%;
            }
        }
        .operation-list {
            font-size: 0.85rem; /* Riduzione dimensione carattere */
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        /* Stili per le intestazioni delle fasi */
        .table-header-sbassatura { background: linear-gradient(135deg, #2962FF, #1565C0); }
        .table-header-scarnitura { background: linear-gradient(135deg, #00C853, #2E7D32); }
        .table-header-segni { background: linear-gradient(135deg, #6200EA, #4527A0); }
        .table-header-applicazioni-termo { background: linear-gradient(135deg, #FF6D00, #E65100); }
        .table-header-applicazioni-manuali { background: linear-gradient(135deg, #D50000, #B71C1C); }
        .table-header-cucitura { background: linear-gradient(135deg, #304FFE, #1A237E); }
        .table-header-ribattitura { background: linear-gradient(135deg, #00BFA5, #00796B); }
        .table-header-preparazione-montaggio { background: linear-gradient(135deg, #FF3D00, #D84315); }
        .table-header-rifilatura { background: linear-gradient(135deg, #C51162, #880E4F); }
        .table-header-tempo-morto { background: linear-gradient(135deg, #610c613b, #880e4f63); }

        @media print {
            .no-print {
                display: none !important;
            }
        }


        .operation-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .operation-color {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 20px;
            border-radius: 4px;
            margin-right: 10px;
            flex-shrink: 0;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .operation-number {
            width: 30px;
            flex-shrink: 0;
            font-weight: bold;
        }

        .operation-description {
            flex-grow: 1;
            padding: 0 10px;
        }

        .operation-time {
            flex-shrink: 0;
            font-family: monospace;
        }

        .total-time {
            font-size: 1.2em;
            font-weight: bold;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 15px;
            text-align: center;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
            position: relative;
            height: 400px;
            page-break-inside: avoid;
        }

        .phase-cards-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .phase-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            page-break-inside: avoid;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .phase-cards-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- HOME SCREEN -->
        <div id="home-screen">
            <h1 class="main-title">Tempi Aggiunteria</h1>
            
            <button class="menu-button btn-prototype" onclick="showScreen('prototype-screen')">
                <i class="fas fa-plus"></i> Nuovo Prototipo
            </button>
            
            <button class="menu-button btn-manual" onclick="showScreen('manual-screen')">
                <i class="fas fa-keyboard"></i> Inserisci Manualmente
            </button>
            
            <button class="menu-button btn-import" onclick="document.getElementById('import-txt-input').click()">
                <i class="fas fa-file-import"></i> Importa tempi da txt
            </button>
            <input type="file" id="import-txt-input" accept=".txt" class="hidden" onchange="handleTxtImport(event)">
            
            <button class="menu-button btn-load" onclick="document.getElementById('load-session-input').click()">
                <i class="fas fa-upload"></i> Carica Sessione Salvata
            </button>
            <input type="file" id="load-session-input" accept=".json" class="hidden" onchange="loadSession(event)">
        </div>

        <!-- PROTOTYPE SCREEN -->
        <div id="prototype-screen" class="hidden">
            <h2 class="text-center mb-4">Nuovo Prototipo</h2>
            
            <div class="form-container">
                <form id="prototype-form" onsubmit="handlePrototypeSubmit(event)">
                    <div class="form-group">
                        <label for="prototype-name">Nome Articolo:</label>
                        <input type="text" id="prototype-name" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label>Immagini:</label>
                        <div class="image-container" id="prototype-gallery"></div>
                        <button type="button" class="btn btn-primary mt-2" 
                                onclick="document.getElementById('prototype-image-input').click()">
                            <i class="fas fa-camera"></i> Aggiungi Foto
                        </button>
                        <input type="file" id="prototype-image-input" accept="image/*" class="hidden" 
                               onchange="handleImageUpload(event, 'prototype')" multiple>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="prototype-start">Orario Inizio:</label>
                            <input type="time" id="prototype-start" class="form-control" step="1">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="prototype-end">Orario Fine:</label>
                            <input type="time" id="prototype-end" class="form-control" step="1">
                        </div>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn btn-success btn-block">Salva Prototipo</button>
                        <button type="button" class="btn btn-secondary btn-block" onclick="showHomeScreen()">
                            Torna alla Home
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MANUAL INPUT SCREEN -->
        <div id="manual-screen" class="hidden">
            <h2 class="text-center mb-4">Inserimento Manuale</h2>
            
            <div class="form-container">
                <form id="manual-form" onsubmit="return false;">
                    <div class="form-row">
                        <div class="form-group col-md-8">
                            <label for="manual-name">Nome Articolo:</label>
                            <input type="text" id="manual-name" class="form-control" required>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="manual-progress">Avanzamento:</label>
                            <select id="manual-progress" class="form-control" required>
                                <option value="campionario">Campionario</option>
                                <option value="industrializzazione">Industrializzazione</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Immagini:</label>
                                <div class="image-container" id="manual-gallery"></div>
                                <button type="button" class="btn btn-primary mt-2" 
                                        onclick="document.getElementById('manual-image-input').click()">
                                    <i class="fas fa-camera"></i> Aggiungi Foto
                                </button>
                                <input type="file" id="manual-image-input" accept="image/*" class="hidden" 
                                       onchange="handleImageUpload(event, 'manual')" multiple>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="time-info">
                                <div class="form-group">
                                    <label for="manual-start">Orario Inizio:</label>
                                    <input type="time" id="manual-start" class="form-control" step="1">
                                </div>
                                <div class="form-group">
                                    <label for="manual-end">Orario Fine:</label>
                                    <input type="time" id="manual-end" class="form-control" step="1">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="manual-phase">Fase:</label>
                        <select id="manual-phase" class="form-control" required>
                            <option value="sbassatura">Sbassatura</option>
                            <option value="scarnitura">Scarnitura</option>
                            <option value="segni">Segni</option>
                            <option value="applicazioni-termo">Applicazioni termo</option>
                            <option value="applicazioni-manuali">Applicazioni manuali/collanti</option>
                            <option value="cucitura">Cucitura</option>
                            <option value="ribattitura">Ribattitura</option>
                            <option value="preparazione-montaggio">Preparazione montaggio</option>
                            <option value="rifilatura">Rifilatura</option>
                            <option value="tempo-morto">Tempo-morto</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="manual-position">Posizione:</label>
                        <input type="text" id="manual-position" class="form-control" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-8">
                            <label for="manual-time">Tempo:</label>
                            <input type="time" id="manual-time" class="form-control" step="1">
                        </div>
                        <div class="form-group col-md-4">
                            <label for="manual-seconds">o Secondi:</label>
                            <input type="number" id="manual-seconds" class="form-control" min="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <button type="button" class="btn btn-primary btn-block" onclick="addManualTime()">
                            Aggiungi Tempo
                        </button>
                        <button type="button" class="btn btn-success btn-block" onclick="handleManualSubmit()">
                            Fine Rilevazioni
                        </button>
                        <button type="button" class="btn btn-secondary btn-block" onclick="showHomeScreen()">
                            Torna alla Home
                        </button>
                    </div>
                </form>

                <div id="manual-operations" class="phase-cards mt-4"></div>
            </div>
        </div>

        <!-- IMPORT SCREEN -->
        <div id="import-screen" class="hidden">
            <h2 class="text-center mb-4">Importa da TXT</h2>
            
            <div class="form-container">
                <form id="import-form">
                    <div class="form-row">
                        <div class="form-group col-md-8">
                            <label for="import-name">Nome Articolo:</label>
                            <input type="text" id="import-name" class="form-control" required>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="import-progress">Avanzamento:</label>
                            <select id="import-progress" class="form-control" required>
                                <option value="campionario">Campionario</option>
                                <option value="industrializzazione">Industrializzazione</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Immagini:</label>
                                <div class="image-container" id="import-gallery"></div>
                                <button type="button" class="btn btn-primary mt-2" 
                                        onclick="document.getElementById('import-image-input').click()">
                                    <i class="fas fa-camera"></i> Aggiungi Foto
                                </button>
                                <input type="file" id="import-image-input" accept="image/*" class="hidden" 
                                       onchange="handleImageUpload(event, 'import')" multiple>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="import-start">Orario Inizio:</label>
                                <input type="time" id="import-start" class="form-control" step="1">
                            </div>
                            <div class="form-group">
                                <label for="import-end">Orario Fine:</label>
                                <input type="time" id="import-end" class="form-control" step="1">
                            </div>
                        </div>
                    </div>

                    <div class="import-operations">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Inizio</th>
                                        <th>Posizione</th>
                                        <th>Durata</th>
                                        <th>Fase</th>
                                    </tr>
                                </thead>
                                <tbody id="import-operations-list"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="form-group mt-4">
                        <button type="button" class="btn btn-success btn-block" onclick="handleImportSubmit()">
                            Fine Rilevazioni
                        </button>
                        <button type="button" class="btn btn-secondary btn-block" onclick="showHomeScreen()">
                            Torna alla Home
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- SUMMARY SCREEN -->
        <div id="summary-screen" class="hidden">
            <div class="summary-container">
                <!-- Il contenuto verrà generato dinamicamente -->
            </div>
        </div>

        <!-- PROTOTYPE SUMMARY SCREEN -->
        <div id="prototype-summary-screen" class="hidden">
            <div class="prototype-summary-container">
                <!-- Il contenuto del summary del prototipo verrà generato dinamicamente -->
            </div>
        </div>
    </div>

    <script>
        // Variabili globali
        let currentSession = {
            type: '',
            name: '',
            progress: '',
            startTime: '',
            endTime: '',
            images: [],
            phases: {},
            operations: []
        };

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            showHomeScreen();
            
            // Aggiungi gestione tasto INVIO per form manuale
            document.getElementById('manual-form').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addManualTime();
                }
            });
        });

        // Funzioni di navigazione
        function showScreen(screenId) {
            hideAllScreens();
            window.scrollTo(0, 0);
            document.getElementById(screenId).classList.remove('hidden');
        }

        function hideAllScreens() {
            const screens = ['home-screen', 'prototype-screen', 'manual-screen', 
                           'import-screen', 'summary-screen', 'prototype-summary-screen'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
        }

        function showHomeScreen() {
            hideAllScreens();
            resetCurrentSession();
            document.getElementById('home-screen').classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function resetCurrentSession() {
            currentSession = {
                type: '',
                name: '',
                progress: '',
                startTime: '',
                endTime: '',
                images: [],
                phases: {},
                operations: []
            };
        }

        // Funzioni di gestione immagini
        async function handleImageUpload(event, context) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            for (const file of files) {
                try {
                    const resizedImage = await resizeAndCompressImage(file);
                    currentSession.images.push(resizedImage);
                    updateImageGallery(context);
                } catch (error) {
                    console.error('Errore nel caricamento dell\'immagine:', error);
                    alert('Errore nel caricamento dell\'immagine');
                }
            }
            event.target.value = '';
        }

        async function resizeAndCompressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // Mantieni l'aspetto originale ma limita a 400x400
                        let width = img.width;
                        let height = img.height;
                        const maxSize = 400;

                        if (width > height) {
                            if (width > maxSize) {
                                height *= maxSize / width;
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width *= maxSize / height;
                                height = maxSize;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function updateImageGallery(context) {
            const gallery = document.getElementById(`${context}-gallery`);
            if (!gallery) return;

            if (currentSession.images.length > 0) {
                const lastImage = currentSession.images[currentSession.images.length - 1];
                gallery.innerHTML = `
                    <div class="image-container">
                        <img src="${lastImage}" alt="Foto">
                        <div class="delete-image" onclick="deleteImage(${currentSession.images.length - 1}, '${context}')">&times;</div>
                    </div>`;
            } else {
                gallery.innerHTML = '';
            }
        }

        function deleteImage(index, context) {
            currentSession.images.splice(index, 1);
            updateImageGallery(context);
        }

        // Funzioni di gestione tempi
        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${String(hrs).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function timeToSeconds(timeStr) {
            if (!timeStr) return 0;
            const parts = timeStr.split(':');
            if (parts.length === 2) {
                parts.unshift('00'); // Aggiungi ore se mancanti
            }
            const [hours, minutes, seconds] = parts.map(Number);
            return (hours * 3600) + (minutes * 60) + (seconds || 0);
        }

        function calculateTimeDifference(startTime, endTime) {
            const start = timeToSeconds(startTime);
            const end = timeToSeconds(endTime);
            return formatTime(end - start);
        }

        // Funzioni di gestione form
        function handlePrototypeSubmit(event) {
            event.preventDefault();
            currentSession = {
                type: 'prototype',
                name: document.getElementById('prototype-name').value,
                progress: 'Prototipo',
                startTime: document.getElementById('prototype-start').value,
                endTime: document.getElementById('prototype-end').value,
                images: currentSession.images,
                phases: {},
                operations: [],
                chronologicalOperations: []
            };
            showPrototypeSummary();
        }

        function addManualTime() {
            const phase = document.getElementById('manual-phase').value;
            const position = document.getElementById('manual-position').value.trim();
            const time = document.getElementById('manual-time').value;
            const seconds = document.getElementById('manual-seconds').value;

            if (!position || (!time && !seconds)) {
                alert('Inserire posizione e tempo');
                return;
            }

            const timeInSeconds = seconds ? 
                parseInt(seconds) : 
                timeToSeconds(time);

            if (!currentSession.phases[phase]) {
                currentSession.phases[phase] = [];
            }

            if (!currentSession.chronologicalOperations) {
                currentSession.chronologicalOperations = [];
            }

            const operation = {
                phase: phase,
                position: position,
                timeSpent: timeInSeconds,
                index: currentSession.chronologicalOperations.length // Indice per mantenere l'ordine
            };

            currentSession.phases[phase].push(operation);
            currentSession.chronologicalOperations.push(operation);

            updateOperationsList();
            clearManualFields();
        }

        function handleManualSubmit() {
            if (!document.getElementById('manual-name').value) {
                alert('Inserire il nome dell\'articolo');
                return;
            }
            
            currentSession.type = 'manual';
            currentSession.name = document.getElementById('manual-name').value;
            currentSession.progress = document.getElementById('manual-progress').value;
            currentSession.startTime = document.getElementById('manual-start').value;
            currentSession.endTime = document.getElementById('manual-end').value;
            showSummary();
        }

        function handleImportSubmit() {
            if (!document.getElementById('import-name').value) {
                alert('Inserire il nome dell\'articolo');
                return;
            }

            organizeOperationsByPhase();
            
            currentSession.type = 'import';
            currentSession.name = document.getElementById('import-name').value;
            currentSession.progress = document.getElementById('import-progress').value;
            currentSession.startTime = document.getElementById('import-start').value;
            currentSession.endTime = document.getElementById('import-end').value;
            showSummary();
        }

        function organizeOperationsByPhase() {
            currentSession.phases = {};
            currentSession.chronologicalOperations = [];
            
            currentSession.operations.forEach((op, index) => {
                if (op.phase) {
                    const operation = {
                        phase: op.phase,
                        position: op.description,
                        timeSpent: timeToSeconds(op.duration),
                        index: index // Preserva l'ordine originale
                    };
                    
                    if (!currentSession.phases[op.phase]) {
                        currentSession.phases[op.phase] = [];
                    }
                    currentSession.phases[op.phase].push(operation);
                    currentSession.chronologicalOperations.push(operation);
                }
            });
            
            // Ordina chronologicalOperations per indice originale
            currentSession.chronologicalOperations.sort((a, b) => a.index - b.index);
        }

        function updateOperationsList() {
            const container = document.getElementById('manual-operations');
            if (!container) return;

            let html = '';
            Object.entries(currentSession.phases).forEach(([phase, operations]) => {
                const totalTime = operations.reduce((acc, curr) => acc + curr.timeSpent, 0);
                
                html += `
                    <div class="phase-card">
                        <div class="phase-header table-header-${phase}">
                            <h6 class="mb-0">${phase.charAt(0).toUpperCase() + phase.slice(1)}</h6>
                            <span class="text-white">${formatTime(totalTime)}</span>
                        </div>
                        <div class="phase-content">
                            <div class="summary-table-responsive">
                                <table class="table table-sm">
                                    <tbody>
                                        ${operations.map((op, index) => `
                                            <tr>
                                                <td>${op.position}</td>
                                                <td class="text-right">
                                                    ${formatTime(op.timeSpent)}
                                                    <button class="btn btn-sm btn-danger ml-2" 
                                                            onclick="deleteOperation('${phase}', ${index})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function clearManualFields() {
            document.getElementById('manual-position').value = '';
            document.getElementById('manual-time').value = '';
            document.getElementById('manual-seconds').value = '';
            document.getElementById('manual-position').focus();
        }

        function deleteOperation(phase, index) {
            if (currentSession.phases[phase]) {
                const deletedOp = currentSession.phases[phase][index];
                // Rimuovi l'operazione dalla fase
                currentSession.phases[phase].splice(index, 1);
                if (currentSession.phases[phase].length === 0) {
                    delete currentSession.phases[phase];
                }
                // Rimuovi l'operazione anche dalla lista cronologica
                if (currentSession.chronologicalOperations) {
                    const chronoIndex = currentSession.chronologicalOperations.findIndex(
                        op => op.phase === phase && op.position === deletedOp.position && op.timeSpent === deletedOp.timeSpent
                    );
                    if (chronoIndex !== -1) {
                        currentSession.chronologicalOperations.splice(chronoIndex, 1);
                    }
                }
                updateOperationsList();
            }
        }

        // Funzioni di gestione import TXT
        function handleTxtImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const lines = content.trim().split('\n');
                    
                    currentSession.operations = [];
                    
                    lines.forEach((line, index) => {
                        const [time, ...descParts] = line.trim().split(' ');
                        const description = descParts.join(' ');
                        
                        // Normalizza il formato del tempo
                        let timeFormatted = time;
                        if (time.split(':').length === 2) {
                            timeFormatted = '00:' + time;
                        }
                        
                        // Calcola la durata
                        let duration = '00:00:00';
                        if (index < lines.length - 1) {
                            const nextTime = lines[index + 1].trim().split(' ')[0];
                            let nextTimeFormatted = nextTime;
                            if (nextTime.split(':').length === 2) {
                                nextTimeFormatted = '00:' + nextTime;
                            }
                            duration = calculateTimeDifference(timeFormatted, nextTimeFormatted);
                        }
                        
                        currentSession.operations.push({
                            startTime: timeFormatted,
                            description: description,
                            duration: duration,
                            phase: ''
                        });
                        // Aggiungi questo codice:
                        currentSession.chronologicalOperations = [];
                        currentSession.operations.forEach((op, index) => {
                            op.index = index; // Aggiungi indice per preservare l'ordine
                        });
                    });
                    
                    showScreen('import-screen');
                    updateImportedOperationsList();
                } catch (error) {
                    console.error('Errore durante l\'importazione:', error);
                    alert('Errore durante l\'importazione del file');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function updateImportedOperationsList() {
            const tbody = document.getElementById('import-operations-list');
            if (!tbody) return;

            tbody.innerHTML = currentSession.operations.map((op, index) => `
                <tr>
                    <td>${op.startTime}</td>
                    <td>
                        <input type="text" class="form-control form-control-sm" 
                               value="${op.description}"
                               onchange="updateOperationDescription(${index}, this.value)">
                    </td>
                    <td>${op.duration}</td>
                    <td>
                        <select class="form-control form-control-sm" 
                                onchange="updateOperationPhase(${index}, this.value)">
                            <option value="">Seleziona fase</option>
                            <option value="sbassatura">Sbassatura</option>
                            <option value="scarnitura">Scarnitura</option>
                            <option value="segni">Segni</option>
                            <option value="applicazioni-termo">Applicazioni termo</option>
                            <option value="applicazioni-manuali">Applicazioni manuali</option>
                            <option value="cucitura">Cucitura</option>
                            <option value="ribattitura">Ribattitura</option>
                            <option value="preparazione-montaggio">Preparazione montaggio</option>
                            <option value="rifilatura">Rifilatura</option>
                            <option value="tempo-morto">Tempo-morto</option>
                        </select>
                    </td>
                </tr>
            `).join('');
        }

        function updateOperationDescription(index, value) {
            currentSession.operations[index].description = value;
        }

        function updateOperationPhase(index, phase) {
            currentSession.operations[index].phase = phase;
        }

        function getPhaseAbbreviation(phase) {
            const abbreviations = {
                'tempo-morto': 'N/D',
                'sbassatura': 'SBA',
                'scarnitura': 'SCA',
                'segni': 'SEG',
                'applicazioni-termo': 'ATR',
                'applicazioni-manuali': 'AMA',
                'cucitura': 'CUC',
                'ribattitura': 'RIB',
                'preparazione-montaggio': 'PMO',
                'rifilatura': 'RIF'
               
            };
            return abbreviations[phase] || phase.substring(0, 3).toUpperCase();
        }

        // Funzioni di riepilogo e salvataggio
        function showPrototypeSummary() {
            const container = document.querySelector('.prototype-summary-container');
            const name = currentSession.name || '';
            const startTime = currentSession.startTime || '';
            const endTime = currentSession.endTime || '';
            const totalTime = (startTime && endTime) ? calculateTimeDifference(startTime, endTime) : '';

            // HTML dedicato al summary del prototipo
            let html = `
                <div class="container p-4">
                    <h2 class="text-center mb-4">Riepilogo Prototipo</h2>
                    
                    <div class="card mb-4">
                        <div class="card-body">
                            <h3 class="card-title">${name}</h3>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Orario Inizio:</strong> ${startTime}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Orario Fine:</strong> ${endTime}</p>
                                </div>
                            </div>
                            <p><strong>Tempo Totale:</strong> ${totalTime}</p>
                        </div>
                    </div>`;

            // Aggiungi la galleria immagini se presenti
            if (currentSession.images && currentSession.images.length > 0) {
                html += `
                    <div class="card mb-4">
                        <div class="card-body">
                            <h4>Immagini</h4>
                            <div class="row">
                                ${currentSession.images.map(img => `
                                    <div class="col-md-6 mb-3">
                                        <img src="${img}" class="img-fluid rounded" alt="Immagine prototipo">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>`;
            }

            // Aggiungi pulsanti per le azioni
            html += `
                    <div class="row mt-4">
                        <div class="col-md-4">
                            <button class="btn btn-primary btn-block" onclick="saveSession()">
                                <i class="fas fa-save"></i> Salva Sessione
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success btn-block" onclick="exportPDF()">
                                <i class="fas fa-file-pdf"></i> Esporta PDF
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-secondary btn-block" onclick="showHomeScreen()">
                                <i class="fas fa-home"></i> Torna alla Home
                            </button>
                        </div>
                    </div>
                </div>`;

            container.innerHTML = html;
            hideAllScreens();
            document.getElementById('prototype-summary-screen').classList.remove('hidden');
        }
        // Funzioni di riepilogo e salvataggio
        function showSummary() {
            const container = document.querySelector('.summary-container');
            const name = currentSession.name || '';
            const progress = currentSession.progress || '';
            const startTime = currentSession.startTime || '';
            const endTime = currentSession.endTime || '';
            const totalTime = (startTime && endTime) ? calculateTimeDifference(startTime, endTime) : '';

            // Usa la proprietà chronologicalOperations solo se esiste ed è un array
            let chronologicalOperations = [];
            if (Array.isArray(currentSession.chronologicalOperations)) {
            chronologicalOperations = currentSession.chronologicalOperations;
            } else if (currentSession.phases && Object.keys(currentSession.phases).length > 0) {
            // Fallback se manca chronologicalOperations ma ci sono fasi
            Object.entries(currentSession.phases).forEach(([phase, operations]) => {
                operations.forEach(op => {
                chronologicalOperations.push({
                    phase: phase,
                    position: op.position,
                    timeSpent: op.timeSpent
                });
                });
            });
            }

            let summaryHTML = `
            <h2 class="text-center mb-4">
            ${name.toUpperCase()}
            <small class="d-block text-muted">${progress}</small>
            </h2>
            <div class="row mb-4">
            <div class="col-md-6">
            ${currentSession.images && currentSession.images.length > 0 ? `
                <div class="image-container">
                <img src="${currentSession.images[0]}" alt="Foto">
                </div>
            ` : ''}
            </div>
            <div class="col-md-6">
            <div class="time-info">
                <h5>Riepilogo Tempi</h5>
                ${startTime ? `<p><strong>Inizio:</strong> ${startTime}</p>` : ''}
                ${endTime ? `<p><strong>Fine:</strong> ${endTime}</p>` : ''}
                ${totalTime ? `<p><strong>Tempo Totale:</strong> ${totalTime}</p>` : ''}
            </div>
            </div>
            </div>
            `;

            // Sezione grafico a torta (Chart.js)
            if (currentSession.phases && Object.keys(currentSession.phases).length > 0) {
            summaryHTML += `
            <div class="row">
                <div class="col-12">
                <div class="chart-container">
                <canvas id="timeChart" height="400"></canvas>
                <div id="total-time" class="total-time"></div>
                </div>
                </div>
            </div>
            `;
            }

            // Mostra la sequenza operazioni solo se ci sono davvero delle operazioni
            if (chronologicalOperations.length > 0) {
            // Divide le operazioni in due colonne
            const half = Math.ceil(chronologicalOperations.length / 2);
            const col1 = chronologicalOperations.slice(0, half);
            const col2 = chronologicalOperations.slice(half);

            summaryHTML += `
            <div class="row">
                <div class="col-12">
                <div class="operation-list">
                    <h5 class="mb-3">Sequenza Operazioni</h5>
                    <div class="row">
                    <div class="col-md-6">
                        ${col1.map((op, index) => `
                        <div class="operation-item">
                            <span class="operation-number">${index + 1}.</span>
                            <span class="operation-color table-header-${op.phase}" style="min-width:40px;display:inline-block;">
                            ${getPhaseAbbreviation(op.phase)}
                            </span>
                            <span class="operation-description">${op.position}</span>
                            <span class="operation-time">${formatTime(op.timeSpent)}</span>
                        </div>
                        `).join('')}
                    </div>
                    <div class="col-md-6">
                        ${col2.map((op, index) => `
                        <div class="operation-item">
                            <span class="operation-number">${half + index + 1}.</span>
                            <span class="operation-color table-header-${op.phase}" style="min-width:40px;display:inline-block;">
                            ${getPhaseAbbreviation(op.phase)}
                            </span>
                            <span class="operation-description">${op.position}</span>
                            <span class="operation-time">${formatTime(op.timeSpent)}</span>
                        </div>
                        `).join('')}
                    </div>
                    </div>
                </div>
                </div>
            </div>
            `;
            }

            // Mostra la tabella riepilogativa per fasi solo se ci sono fasi
            if (currentSession.phases && Object.keys(currentSession.phases).length > 0) {
            summaryHTML += `
            <div class="row">
                <div class="col-12">
                <div class="phase-cards-container">
                ${Object.entries(currentSession.phases).map(([phase, operations]) => {
                    const totalTime = operations.reduce((acc, curr) => acc + curr.timeSpent, 0);
                    return `
                    <div class="phase-card">
                    <div class="phase-header table-header-${phase}">
                    <h6 class="mb-0">${phase.charAt(0).toUpperCase() + phase.slice(1)}</h6>
                    <span class="text-white">${formatTime(totalTime)}</span>
                    </div>
                    <div class="phase-content">
                    <div class="summary-table-responsive">
                        <table class="table table-sm">
                        <tbody>
                        ${operations.map(op => `
                        <tr>
                            <td>${op.position}</td>
                            <td class="text-right">${formatTime(op.timeSpent)}</td>
                        </tr>
                        `).join('')}
                        </tbody>
                        </table>
                    </div>
                    </div>
                    </div>
                    `;
                }).join('')}
                </div>
                </div>
            </div>
            `;
            }

            // Pulsanti di azione
            summaryHTML += `
            <div class="row mt-4">
            <div class="col-12 text-center">
            <button class="btn btn-secondary mr-2" onclick="showHomeScreen()">Torna alla Home</button>
            <button class="btn btn-info ml-2" onclick="window.print()"><i class="fas fa-print"></i> Stampa</button>
            <button class="btn btn-success ml-2" onclick="saveSession()"><i class="fas fa-save"></i> Salva Sessione</button>
            </div>
            </div>
            `;

            container.innerHTML = summaryHTML;
            showScreen('summary-screen');

            if (currentSession.phases && Object.keys(currentSession.phases).length > 0) {
            createTimeChart();
            }
        }

        function createTimeChart() {
            const ctx = document.getElementById('timeChart');
            if (!ctx) return;

            const phases = Object.keys(currentSession.phases);
            const times = phases.map(phase => 
                currentSession.phases[phase].reduce((acc, curr) => acc + curr.timeSpent, 0)
            );

            const labels = phases.map(phase => {
                const totalTime = currentSession.phases[phase].reduce((acc, curr) => acc + curr.timeSpent, 0);
                return `${phase.charAt(0).toUpperCase() + phase.slice(1)} (${formatTime(totalTime)})`;
            });

            // Distruggi il grafico esistente se presente
            if (window.timeChart instanceof Chart) {
                window.timeChart.destroy();
            }

            // Funzione per aggiornare il totale
            function updateTotal() {
                const totalElement = document.getElementById('total-time');
                if (!totalElement) return;

                const meta = window.timeChart.getDatasetMeta(0);
                const total = meta.data.reduce((acc, element, index) => {
                    if (!element.hidden) {
                        return acc + times[index];
                    }
                    return acc;
                }, 0);

                totalElement.textContent = `Tempo Totale: ${formatTime(total)}`;
            }

            window.timeChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: times,
                        backgroundColor: [
                            '#2962FF', '#00C853', '#6200EA', '#FF6D00',
                            '#D50000', '#304FFE', '#00BFA5', '#FF3D00',
                            '#C51162'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            onClick: function(e, legendItem, legend) {
                                const index = legendItem.index;
                                const ci = this.chart;
                                const meta = ci.getDatasetMeta(0);
                                meta.data[index].hidden = !meta.data[index].hidden;
                                ci.update();
                                updateTotal();
                            }
                        }
                    }
                }
            });

            // Calcola il totale iniziale
            updateTotal();
        }

        function savePDF() {
            const container = document.querySelector('.summary-container');
            const fileName = `${currentSession.name}-${currentSession.progress}.pdf`;

            // Creiamo un clone del container per modificarlo senza influenzare la pagina
            const printContainer = container.cloneNode(true);
            
            // Rimuoviamo i bottoni dalla versione di stampa
            const buttons = printContainer.querySelector('.no-print');
            if (buttons) buttons.remove();

            // Creiamo un contenitore temporaneo per la stampa
            const printContent = document.createElement('div');
            printContent.appendChild(printContainer);
            document.body.appendChild(printContent);

            // Configurazione per la stampa
            const printOptions = {
                margin: 10,
                filename: fileName,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    logging: false
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait' 
                }
            };

            // Stampa in PDF
            html2pdf()
                .set(printOptions)
                .from(printContent)
                .save()
                .then(() => {
                    // Rimuovi il contenitore temporaneo
                    document.body.removeChild(printContent);
                });
        }

        function saveSession() {
            const fileName = `${currentSession.name}-${currentSession.progress}.json`;
            const data = JSON.stringify(currentSession);
            const blob = new Blob([data], { type: 'application/json;charset=utf-8' });
            saveAs(blob, fileName);
        }

        function loadSession(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    currentSession = JSON.parse(e.target.result);
                    
                    // Popola i campi nella pagina manual-screen
                    document.getElementById('manual-name').value = currentSession.name;
                    document.getElementById('manual-progress').value = currentSession.progress;
                    document.getElementById('manual-start').value = currentSession.startTime;
                    document.getElementById('manual-end').value = currentSession.endTime;
                    
                    // Aggiorna la galleria immagini
                    updateImageGallery('manual');
                    
                    // Aggiorna la lista delle operazioni
                    updateOperationsList();
                    
                    // Mostra la pagina manual-screen invece del summary
                    showScreen('manual-screen');
                } catch (error) {
                    console.error('Errore durante il caricamento della sessione:', error);
                    alert('Errore durante il caricamento del file');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
    </script>
</body>
</html>