<!DOCTYPE html>
<html lang="it">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>Tempi Aggiunteria</title>
        
        <!-- Librerie CSS esterne -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
        
        <!-- Script necessari -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

        <style>
            /* Variabili CSS */
            :root {
                --primary-color: #2D3142;
                --secondary-color: #4F5D75;
                --accent-color: #0066FF;
                --background-light: #F9FAFC;
                --text-primary: #2D3142;
                --text-secondary: #4F5D75;
                --success-color: #36B37E;
                --error-color: #FF5630;
            }

            /* Stili di base */
            body { 
                background-color: var(--background-light);
                padding: 10px;
                touch-action: manipulation;
                color: var(--text-primary);
                line-height: 1.6;
            }

            .container {
                background-color: white;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(45, 49, 66, 0.08);
                padding: 24px;
                margin-bottom: 20px;
                max-width: 100%;
                border: 1px solid rgba(0, 0, 0, 0.05);
            }

            /* Stili dei pulsanti */
            .btn {
                padding: 12px 24px;
                margin: 6px 0;
                font-size: 1.1em;
                border-radius: 8px;
                transition: all 0.3s ease;
                font-weight: 500;
            }

            .btn-primary { background: var(--accent-color); border: none; }
            .btn-primary:hover {
                background: #005ae6;
                transform: translateY(-1px);
                box-shadow: 0 4px 8px rgba(0, 102, 255, 0.2);
            }

            .btn-success { background: var(--success-color); border: none; }
            .btn-success:hover {
                background: #2d8f63;
                transform: translateY(-1px);
                box-shadow: 0 4px 8px rgba(54, 179, 126, 0.2);
            }

            /* Stili degli input */
            input, select {
                height: 48px !important;
                font-size: 16px !important;
                border-radius: 8px !important;
                border: 1px solid rgba(79, 93, 117, 0.2) !important;
                padding: 0 16px !important;
                transition: all 0.2s ease !important;
            }

            input:focus, select:focus {
                border-color: var(--accent-color) !important;
                box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1) !important;
                outline: none !important;
            }

            .input-error {
                border-color: var(--error-color) !important;
            }

            /* Stili della galleria immagini */
            .image-gallery {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 12px;
                margin: 15px 0;
            }

            .image-container {
                position: relative;
                width: 300px;
                height: 300px;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 4px rgba(45, 49, 66, 0.1);
                margin: 0 auto;
            }

            .image-container img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform 0.3s ease;
            }

            .image-container:hover img { transform: scale(1.05); }

            .delete-image {
                position: absolute;
                top: 4px;
                right: 4px;
                background: var(--error-color);
                color: white;
                border-radius: 50%;
                width: 24px;
                height: 24px;
                text-align: center;
                line-height: 24px;
                cursor: pointer;
                opacity: 0.9;
                transition: all 0.2s ease;
            }

            .delete-image:hover {
                opacity: 1;
                transform: scale(1.1);
            }

            /* Altri stili di layout */
            .time-info {
                background: var(--background-light);
                border-radius: 8px;
                padding: 10px;
                margin-top: 10px;
            }

            .positions-list {
                margin-top: 20px;
                background: var(--background-light);
                border-radius: 12px;
                padding: 16px;
            }

            .positions-list li {
                padding: 12px 16px;
                border-bottom: 1px solid rgba(79, 93, 117, 0.1);
                margin-bottom: 8px;
                background: white;
                border-radius: 8px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                transition: all 0.2s ease;
            }

            /* Utility classes */
            .hidden { display: none; }

            /* Media queries */
            @media print { 
                .no-print { display: none; }
                body { background: white; }
                .container { box-shadow: none; border: none; }
                .summary-container {
                    width: 100%;
                    max-width: none;
                    margin: 0;
                    padding: 0;
                }
                .row { page-break-inside: avoid; }
                .card { break-inside: avoid; }
                canvas { max-height: 100%; width: auto; }
            }

            @media (max-width: 768px) {
                .container { padding: 16px; }
                .btn { padding: 10px 20px; }
                .image-gallery {
                    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                }
            }
        </style>
    </head>
        <body>
        <div class="container">
            <h1 class="text-center mb-4">Tempi Aggiunteria</h1>

            <!-- HOME SCREEN -->
            <div id="home-screen">
                <button class="btn btn-success btn-block" id="newPrototypeBtn">
                    <i class="fas fa-plus"></i> Nuovo Prototipo
                </button>
                <button class="btn btn-primary btn-block" id="manualInputBtn">
                    <i class="fas fa-keyboard"></i> Inserisci Manualmente
                </button>
                <button class="btn btn-warning btn-block" id="importTxtBtn">
                    <i class="fas fa-file-import"></i> Importa tempi da txt
                </button>
                <input type="file" class="d-none" id="import-txt-input" accept=".txt">
                <button class="btn btn-info btn-block" id="loadSessionBtn">
                    <i class="fas fa-upload"></i> Carica Sessione Salvata
                </button>
                <input type="file" class="d-none" id="load-session-input" accept=".json">
            </div>

            <!-- NUOVO PROTOTIPO SCREEN -->
            <form id="new-prototype-form" class="hidden">
                <h4 class="mb-3 text-center">Nuovo Prototipo</h4>
                
                <div class="form-row">
                    <div class="form-group col-12">
                        <label for="prototype-name">Nome Articolo:</label>
                        <input type="text" id="prototype-name" name="name" class="form-control" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Avanzamento:</label>
                    <input type="text" class="form-control" value="Prototipo" readonly>
                </div>

                <div class="form-group">
                    <label>Immagini:</label>
                    <div class="image-gallery" id="image-gallery-prototype"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="prototypePhotoBtn">
                        <i class="fas fa-camera"></i> Aggiungi Foto
                    </button>
                    <input type="file" id="prototype-image-input" class="hidden" accept="image/*" capture="camera">
                </div>

                <div class="form-row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="prototype-start-time">Orario Inizio:</label>
                            <input type="text" id="prototype-start-time" name="start-time" class="form-control" 
                                   placeholder="00:00:00" pattern="^\d{2}:\d{2}:\d{2}$">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="prototype-end-time">Orario Fine:</label>
                            <input type="text" id="prototype-end-time" name="end-time" class="form-control" 
                                   placeholder="00:00:00" pattern="^\d{2}:\d{2}:\d{2}$">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <button type="submit" class="btn btn-success btn-block">Fine Rilevazioni</button>
                    <button type="button" class="btn btn-outline-secondary btn-block" id="homeBtn">
                        Torna alla Home
                    </button>
                </div>
            </form>

            <!-- MANUAL INPUT SCREEN -->
            <form id="manual-input-form" class="hidden">
                <h4 class="mb-3 text-center">Inserisci Manualmente</h4>
                
                <div class="form-row">
                    <div class="form-group col-md-8">
                        <label for="article-name-manual">Nome Articolo:</label>
                        <input type="text" id="article-name-manual" name="name" class="form-control" required>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="progress-manual">Avanzamento:</label>
                        <select id="progress-manual" name="progress" class="form-control" required>
                            <option value="campionario">Campionario</option>
                            <option value="industrializzazione">Industrializzazione</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="col-md-6">
                        <label>Immagini:</label>
                        <div class="image-gallery" id="image-gallery-manual"></div>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="manualPhotoBtn">
                            <i class="fas fa-camera"></i> Aggiungi Foto
                        </button>
                        <input type="file" id="manual-image-input" class="hidden" accept="image/*" capture="camera">
                    </div>
                    <div class="col-md-6">
                        <div class="time-info">
                            <div class="form-group">
                                <label for="manual-start-time">Orario Inizio:</label>
                                <input type="text" id="manual-start-time" name="start-time" class="form-control" 
                                       placeholder="00:00:00" pattern="^\d{2}:\d{2}:\d{2}$">
                            </div>
                            <div class="form-group">
                                <label for="manual-end-time">Orario Fine:</label>
                                <input type="text" id="manual-end-time" name="end-time" class="form-control" 
                                       placeholder="00:00:00" pattern="^\d{2}:\d{2}:\d{2}$">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="phase-manual">Fase:</label>
                    <select id="phase-manual" name="phase" class="form-control" required>
                        <option value="sbassatura">Sbassatura</option>
                        <option value="scarnitura">Scarnitura</option>
                        <option value="segni">Segni</option>
                        <option value="applicazioni-termo">Applicazioni termo</option>
                        <option value="applicazioni-manuali">Applicazioni manuali/collanti</option>
                        <option value="cucitura">Cucitura</option>
                        <option value="ribattitura">Ribattitura</option>
                        <option value="preparazione-montaggio">Preparazione montaggio</option>
                        <option value="rifilatura">Rifilatura</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="position-manual">Posizione:</label>
                    <input type="text" id="position-manual" name="position" class="form-control" required>
                </div>

                <div class="form-row">
                    <div class="form-group col-8">
                        <label for="manual-time">Tempo (hh:mm:ss):</label>
                        <input type="text" id="manual-time" class="form-control" placeholder="00:00:00" 
                               pattern="^\d{2}:\d{2}:\d{2}$">
                    </div>
                    <div class="form-group col-4">
                        <label for="manual-seconds">o Secondi:</label>
                        <input type="number" id="manual-seconds" class="form-control" placeholder="in sec.">
                    </div>
                </div>

                <div class="form-group">
                    <button type="button" class="btn btn-secondary btn-block" id="add-manual-btn">Aggiungi</button>
                    <button type="submit" class="btn btn-success btn-block">Fine Rilevazioni</button>
                    <button type="button" class="btn btn-outline-secondary btn-block homeBtn">Torna alla Home</button>
                </div>

                <div class="positions-list hidden" id="positions-list-manual">
                    <h3>Posizioni Inserite</h3>
                    <ul id="positions-data-manual" class="list-unstyled"></ul>
                </div>
            </form>

            <!-- IMPORT FORM -->
            <form id="import-form" class="hidden">
                <h4 class="mb-3 text-center">Importa tempi da txt</h4>
                
                <div class="form-row">
                    <div class="form-group col-md-8">
                        <label for="article-name-import">Nome Articolo:</label>
                        <input type="text" id="article-name-import" name="name" class="form-control" required>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="progress-import">Avanzamento:</label>
                        <select id="progress-import" name="progress" class="form-control" required>
                            <option value="campionario">Campionario</option>
                            <option value="industrializzazione">Industrializzazione</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="col-md-6">
                        <label>Immagini:</label>
                        <div class="image-gallery" id="image-gallery-import"></div>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="importPhotoBtn">
                            <i class="fas fa-camera"></i> Aggiungi Foto
                        </button>
                        <input type="file" id="import-image-input" class="hidden" accept="image/*" capture="camera">
                    </div>
                    <div class="col-md-6">
                        <div class="time-info">
                            <div class="form-group">
                                <label for="import-start-time">Orario Inizio:</label>
                                <input type="text" id="import-start-time" name="start-time" class="form-control" 
                                       placeholder="00:00:00" pattern="^\d{2}:\d{2}:\d{2}$">
                            </div>
                            <div class="form-group">
                                <label for="import-end-time">Orario Fine:</label>
                                <input type="text" id="import-end-time" name="end-time" class="form-control" 
                                       placeholder="00:00:00" pattern="^\d{2}:\d{2}:\d{2}$">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="imported-operations">
                    <h5 class="mb-3">Operazioni Importate</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>N°</th>
                                    <th>Inizio</th>
                                    <th>Posizione</th>
                                    <th>Durata</th>
                                    <th>Fase</th>
                                </tr>
                            </thead>
                            <tbody id="imported-operations-list"></tbody>
                        </table>
                    </div>
                </div>

                <div class="form-group mt-4">
                    <button type="submit" class="btn btn-success btn-block">Fine Rilevazioni</button>
                    <button type="button" class="btn btn-outline-secondary btn-block homeBtn">Torna alla Home</button>
                </div>
            </form>
        </div>
                <!-- Script necessari -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <!-- Il nostro JavaScript -->
        <script>
            // App State e Navigation
            const AppState = {
                currentScreen: 'home',
                prototype: {
                    images: [],
                    name: '',
                    startTime: '',
                    endTime: ''
                },
                manual: {
                    images: [],
                    articleName: '',
                    progress: 'campionario',
                    startTime: '',
                    endTime: '',
                    phaseData: {},
                    savedAt: ''
                },
                import: {
                    images: [],
                    operations: [],
                    articleName: '',
                    progress: 'campionario',
                    startTime: '',
                    endTime: ''
                }
            };

            const Navigation = {
                showScreen: (screenId) => {
                    const screens = ['home-screen', 'new-prototype-form', 'manual-input-form', 'import-form'];
                    screens.forEach(screen => {
                        document.getElementById(screen).classList.toggle('hidden', screen !== screenId);
                    });
                    AppState.currentScreen = screenId;
                },
                
                init: () => {
                    document.getElementById('newPrototypeBtn').addEventListener('click', () => Navigation.showScreen('new-prototype-form'));
                    document.getElementById('manualInputBtn').addEventListener('click', () => Navigation.showScreen('manual-input-form'));
                    document.getElementById('homeBtn').addEventListener('click', () => Navigation.showScreen('home-screen'));
                    document.getElementById('importTxtBtn').addEventListener('click', () => Navigation.showScreen('import-form'));

                    // Eventi per i pulsanti "Torna alla Home"
                    document.querySelectorAll('.homeBtn').forEach(btn => {
                        btn.addEventListener('click', () => Navigation.showScreen('home-screen'));
                    });

                    // Eventi per i pulsanti delle foto
                    document.getElementById('prototypePhotoBtn').addEventListener('click', () => {
                        document.getElementById('prototype-image-input').click();
                    });
                    document.getElementById('manualPhotoBtn').addEventListener('click', () => {
                        document.getElementById('manual-image-input').click();
                    });
                    document.getElementById('importPhotoBtn').addEventListener('click', () => {
                        document.getElementById('import-image-input').click();
                    });

                    // Eventi per l'upload delle immagini
                    document.getElementById('prototype-image-input').addEventListener('change', (e) => ImageHandler.handleImageUpload(e, 'prototype'));
                    document.getElementById('manual-image-input').addEventListener('change', (e) => ImageHandler.handleImageUpload(e, 'manual'));
                    document.getElementById('import-image-input').addEventListener('change', (e) => ImageHandler.handleImageUpload(e, 'import'));

                    // Eventi per l'importazione dei file
                    document.getElementById('import-txt-input').addEventListener('change', (e) => ImportHandler.handleTxtImport(e));
                    document.getElementById('load-session-input').addEventListener('change', (e) => ImportHandler.loadSessionFromFile(e));
                }
            };

            // Image Handler
            const ImageHandler = {
                async resizeImage(file) {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = new Image();
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                canvas.width = 300;
                                canvas.height = 300;
                                
                                const size = Math.min(img.width, img.height);
                                const startX = (img.width - size) / 2;
                                const startY = (img.height - size) / 2;
                                
                                ctx.drawImage(img, startX, startY, size, size, 0, 0, 300, 300);
                                resolve(canvas.toDataURL('image/jpeg', 0.8));
                            };
                            img.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    });
                },

                updateGallery(context) {
                    const galleryId = `image-gallery-${context}`;
                    const images = AppState[context].images;
                    
                    const gallery = document.getElementById(galleryId);
                    if (gallery && images) {
                        gallery.innerHTML = images.map((imageData, index) => `
                            <div class="image-container">
                                <img src="${imageData}" alt="Foto ${index + 1}">
                                <div class="delete-image" data-index="${index}" data-context="${context}">&times;</div>
                            </div>
                        `).join('');
                    }
                },

                async handleImageUpload(event, context) {
                    const file = event.target.files[0];
                    if (file) {
                        const resizedImage = await this.resizeImage(file);
                        AppState[context].images.push(resizedImage);
                        this.updateGallery(context);
                    }
                },

                deleteImage(index, context) {
                    AppState[context].images.splice(index, 1);
                    this.updateGallery(context);
                },

                init() {
                    // Event delegation per la gestione delle immagini
                    document.addEventListener('click', (e) => {
                        if (e.target.classList.contains('delete-image')) {
                            const { index, context } = e.target.dataset;
                            this.deleteImage(parseInt(index), context);
                        }
                    });
                }
            };

            // Time Handler
            const TimeHandler = {
                formatTime(seconds) {
                    const hrs = Math.floor(seconds / 3600);
                    const mins = Math.floor((seconds % 3600) / 60);
                    const secs = seconds % 60;
                    return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                },

                timeStringToSeconds(str) {
                    if (/^\d+$/.test(str)) return parseInt(str, 10);
                    const parts = str.split(':');
                    if (parts.length !== 3) return 0;
                    return parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
                },

                calculateTimeDifference(startTime, endTime) {
                    const start = this.timeStringToSeconds(startTime);
                    const end = this.timeStringToSeconds(endTime);
                    return this.formatTime(end - start);
                },

                validateTimeFormat(input) {
                    const timeRegex = /^\d{2}:\d{2}:\d{2}$/;
                    const isValid = timeRegex.test(input.value);
                    input.classList.toggle('input-error', !isValid && input.value !== '');
                    return isValid;
                }
            };

            // Import Handler
            const ImportHandler = {
                handleTxtImport(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const content = e.target.result;
                            const lines = content.trim().split('\n');
                            
                            AppState.import.operations = [];
                            lines.forEach((line, index) => {
                                const [number, startTime, description] = line.trim().split(',');
                                let duration = '00:00:00';
                                
                                if (index < lines.length - 1) {
                                    const nextLine = lines[index + 1];
                                    const nextStartTime = nextLine.split(',')[1];
                                    duration = TimeHandler.calculateTimeDifference(startTime, nextStartTime);
                                }
                                
                                AppState.import.operations.push({
                                    number: parseInt(number),
                                    startTime,
                                    description: description.trim(),
                                    duration,
                                    phase: ''
                                });
                            });
                            
                            this.updateImportedOperationsTable();
                            Navigation.showScreen('import-form');
                        };
                        reader.readAsText(file);
                    }
                },

                updateImportedOperationsTable() {
                    const tbody = document.getElementById('imported-operations-list');
                    if (!tbody) return;

                    tbody.innerHTML = AppState.import.operations.map(op => `
                        <tr>
                            <td>${op.number}</td>
                            <td>${op.startTime}</td>
                            <td>
                                <input type="text" class="form-control form-control-sm" 
                                    value="${op.description}" 
                                    onchange="ImportHandler.updateOperationDescription(${op.number - 1}, this.value)">
                            </td>
                            <td>${op.duration}</td>
                            <td>
                                <select class="form-control form-control-sm" 
                                        onchange="ImportHandler.updateOperationPhase(${op.number - 1}, this.value)">
                                    <option value="">Seleziona fase...</option>
                                    <option value="sbassatura">Sbassatura</option>
                                    <option value="scarnitura">Scarnitura</option>
                                    <option value="segni">Segni</option>
                                    <option value="applicazioni-termo">Applicazioni termo</option>
                                    <option value="applicazioni-manuali">Applicazioni manuali/collanti</option>
                                    <option value="cucitura">Cucitura</option>
                                    <option value="ribattitura">Ribattitura</option>
                                    <option value="preparazione-montaggio">Preparazione montaggio</option>
                                    <option value="rifilatura">Rifilatura</option>
                                </select>
                            </td>
                        </tr>
                    `).join('');

                    // Imposta i valori delle fasi selezionate
                    AppState.import.operations.forEach((op, index) => {
                        if (op.phase) {
                            const select = tbody.querySelectorAll('select')[index];
                            if (select) select.value = op.phase;
                        }
                    });
                },

                updateOperationDescription(index, value) {
                    AppState.import.operations[index].description = value;
                },

                updateOperationPhase(index, value) {
                    AppState.import.operations[index].phase = value;
                },

                loadSessionFromFile(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const session = JSON.parse(e.target.result);
                                Object.assign(AppState.manual, session);
                                Navigation.showScreen('manual-input-form');
                                ImageHandler.updateGallery('manual');
                                this.updatePositionsListManual();
                            } catch (error) {
                                console.error('Errore nel caricamento della sessione:', error);
                                alert('Errore nel caricamento del file di sessione');
                            }
                        };
                        reader.readAsText(file);
                    }
                },

                updatePositionsListManual() {
                    const positionsList = document.getElementById('positions-data-manual');
                    if (!positionsList) return;

                    let html = '';
                    Object.entries(AppState.manual.phaseData).forEach(([phase, data]) => {
                        data.forEach((item, index) => {
                            html += `
                                <li>
                                    <div>
                                        <strong>${phase}:</strong> ${item.position}
                                        <small class="text-muted d-block">Tempo: ${TimeHandler.formatTime(item.timeSpent)}</small>
                                    </div>
                                    <button class="btn btn-sm btn-danger" onclick="ImportHandler.deletePosition('${phase}', ${index})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </li>
                            `;
                        });
                    });

                    positionsList.innerHTML = html;
                    document.getElementById('positions-list-manual').classList.remove('hidden');
                },

                deletePosition(phase, index) {
                    if (AppState.manual.phaseData[phase]) {
                        AppState.manual.phaseData[phase].splice(index, 1);
                        if (AppState.manual.phaseData[phase].length === 0) {
                            delete AppState.manual.phaseData[phase];
                        }
                        this.updatePositionsListManual();
                    }
                }
            };

            // Prototype Handler
            const PrototypeHandler = {
                addPrototype(form) {
                    const formData = new FormData(form);
                    
                    if (!this.validatePrototypeData(formData)) return;

                    const totalTime = TimeHandler.calculateTimeDifference(
                        formData.get('start-time'),
                        formData.get('end-time')
                    );

                    this.showPrototypeSummary(formData, totalTime);
                },

                validatePrototypeData(formData) {
                    let isValid = true;
                    
                    if (!formData.get('name')) {
                        document.getElementById('prototype-name').classList.add('input-error');
                        isValid = false;
                    }

                    const startTime = formData.get('start-time');
                    const endTime = formData.get('end-time');

                    if (startTime && !TimeHandler.validateTimeFormat(document.getElementById('prototype-start-time'))) {
                        isValid = false;
                    }
                    if (endTime && !TimeHandler.validateTimeFormat(document.getElementById('prototype-end-time'))) {
                        isValid = false;
                    }

                    return isValid;
                },

                showPrototypeSummary(formData, totalTime) {
                    const container = document.querySelector('.container');
                    const gallery = AppState.prototype.images.map((imageData, index) => `
                        <div class="image-container">
                            <img src="${imageData}" alt="Foto ${index + 1}">
                        </div>
                    `).join('');

                    container.innerHTML = this.generateSummaryHTML(formData, gallery, totalTime);
                },

                generateSummaryHTML(formData, gallery, totalTime) {
                    return `
                        <div class="summary-container">
                            <h2 class="text-center mb-3">
                                ${formData.get('name').toUpperCase()}
                                <small class="d-block text-muted">Prototipo</small>
                            </h2>
                            
                            <div class="row mb-3">
                                <div class="col-md-6 mx-auto">
                                    <div class="image-gallery">${gallery}</div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mx-auto">
                                    <div class="time-info">
                                        ${formData.get('start-time') ? `<p><strong>Inizio:</strong> ${formData.get('start-time')}</p>` : ''}
                                        ${formData.get('end-time') ? `<p><strong>Fine:</strong> ${formData.get('end-time')}</p>` : ''}
                                        <p><strong>Tempo Totale:</strong> ${totalTime}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="text-center mt-3 mb-2 no-print">
                                <button onclick="PDFHandler.generatePDF('${formData.get('name')}', 'Prototipo')" 
                                        class="btn btn-success mx-1">
                                    <i class="fas fa-save"></i> Salva PDF
                                </button>
                                <button onclick="location.reload()" class="btn btn-outline-secondary mx-1">
                                    <i class="fas fa-redo"></i> Nuova Rilevazione
                                </button>
                            </div>
                        </div>
                    `;
                },

                init() {
                    const form = document.getElementById('new-prototype-form');
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.addPrototype(form);
                    });
                }
            };

            // PDF Handler
            const PDFHandler = {
                async generatePDF(articleName, progress) {
                    const element = document.querySelector('.summary-container');
                    const opt = {
                        margin: 1,
                        filename: `${articleName}_${progress}_${new Date().toISOString().split('T')[0]}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2 },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                    };

                    try {
                        await html2pdf().set(opt).from(element).save();
                    } catch (error) {
                        console.error('Errore durante la generazione del PDF:', error);
                        alert('Si è verificato un errore durante la generazione del PDF');
                    }
                }
            };

            // Inizializzazione
            document.addEventListener('DOMContentLoaded', () => {
                Navigation.init();
                ImageHandler.init();
                PrototypeHandler.init();
            });
        </script>
    </body>
</html>